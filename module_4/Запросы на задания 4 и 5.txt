4. Изучаем закономерности в данных
Задание 4.1 
База данных содержит список аэропортов практически всех крупных городов России. В большинстве городов есть только один аэропорт. Исключение составляет:

select 
    a.city
from 
    dst_project.airports a
group by 1
having count(a.airport_code) > 1  

Задание 4.2 
Вопрос 1. Таблица рейсов содержит всю информацию о прошлых, текущих и запланированных рейсах. Сколько всего статусов для рейсов определено в таблице?

select 
    count(distinct f.status)
from 
    dst_project.flights f
    
Вопрос 2. Какое количество самолетов находятся в воздухе на момент среза в базе (статус рейса «самолёт уже вылетел и находится в воздухе»).

select 
    count(f.flight_id)
from 
    dst_project.flights f
where
    f.status = 'Departed'
    
Вопрос 3. Места определяют схему салона каждой модели. Сколько мест имеет самолет модели 773 (Boeing 777-300)?

select 
    count(s.seat_no)
from 
    dst_project.seats s
where
    s.aircraft_code = '773'
    
Вопрос 4. Сколько состоявшихся (фактических) рейсов было совершено между 1 апреля 2017 года и 1 сентября 2017 года? 

select 
    count(f.flight_id)
from 
    dst_project.flights f
where
    f.status != 'Cancelled'
    and f.actual_arrival between 'April 1, 2017'::date and 'September 1, 2017'::date
    
Задание 4.3
Вопрос 1. Сколько всего рейсов было отменено по данным базы?

select 
    count(f.flight_id)
from 
    dst_project.flights f
where
    f.status = 'Cancelled'
    
Вопрос 2. Сколько самолетов моделей типа Boeing, Sukhoi Superjet, Airbus находится в базе авиаперевозок?

select
    count(case when a.model like 'Boeing%' then a.aircraft_code end) count_boeing,
    count(case when a.model like 'Sukhoi Superjet%' then a.aircraft_code end) count_ss,
    count(case when a.model like 'Airbus%' then a.aircraft_code end) count_airbus
from
    dst_project.aircrafts a

Вопрос 3. В какой части (частях) света находится больше аэропортов? 

select 
    a.timezone,
    count(a.airport_code)
from 
    dst_project.airports a
group by 1
order by 2 desc

Вопрос 4. У какого рейса была самая большая задержка прибытия за все время сбора данных? Введите id рейса (flight_id).

select 
    f.flight_id,
    f.actual_arrival,
    f.scheduled_arrival,
    f.actual_arrival - f.scheduled_arrival diff
from 
    dst_project.flights f 
where f.actual_arrival is not null
    and f.scheduled_arrival is not null
order by 4 desc
limit 1

Задание 4.4 
Вопрос 1. Когда был запланирован самый первый вылет, сохраненный в базе данных?

select 
    f.flight_id,
    f.scheduled_departure
from 
    dst_project.flights f 
order by 2
limit 1

Вопрос 2. Сколько минут составляет запланированное время полета в самом длительном рейсе
select 
    f.flight_id,
    f.scheduled_arrival - f.scheduled_departure diff,
    extract(minute from f.scheduled_arrival - f.scheduled_departure) min_extract,
    extract(hour from f.scheduled_arrival - f.scheduled_departure)*60 + extract(minute from f.scheduled_arrival - f.scheduled_departure) all_minutes
from 
    dst_project.flights f 
order by 4 desc

Вопрос 3. Между какими аэропортами пролегает самый длительный по времени запланированный рейс? 

select 
    f.flight_id,
    extract(hour from f.scheduled_arrival - f.scheduled_departure)*60 + extract(minute from f.scheduled_arrival - f.scheduled_departure) all_minutes,
    f.departure_airport,
    f.arrival_airport
from 
    dst_project.flights f 
order by 2 desc

Вопрос 4. Сколько составляет средняя дальность полета среди всех самолетов в минутах? Секунды округляются в меньшую сторону (отбрасываются до минут)

select 
    avg(extract(hour from f.scheduled_arrival - f.scheduled_departure)*60 + extract(minute from f.scheduled_arrival - f.scheduled_departure))
from 
    dst_project.flights f 
    
Задание 4.5
Вопрос 1. Мест какого класса у SU9 больше всего?

select
    distinct s.fare_conditions, 
    count(s.seat_no) over (partition by s.fare_conditions)
from
    dst_project.seats s 
where
    s.aircraft_code = 'SU9'
order by 2 desc

Вопрос 2. Какую самую минимальную стоимость составило бронирование за всю историю? 

select
    min(b.total_amount)
from 
    dst_project.bookings b
    
Вопрос 3. Какой номер места был у пассажира с id = 4313 788533

select
    bp.seat_no
from 
    dst_project.tickets t
    join dst_project.boarding_passes bp on t.ticket_no = bp.ticket_no
where
    t.passenger_id = '4313 788533'
    
5. Предварительный анализ
Задание 5.1 
Вопрос 1. Анапа — курортный город на юге России. Сколько рейсов прибыло в Анапу за 2017 год?

select
    count(f.flight_id)
from 
    dst_project.flights f
    join dst_project.airports a on f.arrival_airport = a.airport_code
where
    a.city = 'Anapa'
    and extract(year from f.actual_arrival) = '2017'
    
Вопрос 2. Сколько рейсов из Анапы вылетело зимой 2017 года?

select
    count(f.flight_id)
from 
    dst_project.flights f
    join dst_project.airports a on f.departure_airport = a.airport_code
where
    a.city = 'Anapa'
    and extract(year from f.actual_departure) = '2017'
    and extract(month from f.actual_departure) in (12,1,2)

Вопрос 3. Посчитайте количество отмененных рейсов из Анапы за все время

select
    count(f.flight_id)
from 
    dst_project.flights f
    join dst_project.airports a on f.departure_airport = a.airport_code
where
    a.city = 'Anapa'
    and f.status = 'Cancelled'

Вопрос 4. Сколько рейсов из Анапы не летают в Москву?

select
    sum(count(f.flight_id)) over ()
from 
    dst_project.flights f
    join dst_project.airports a on f.departure_airport = a.airport_code
    join dst_project.airports aa on f.arrival_airport = aa.airport_code
where
    a.city = 'Anapa'
    and aa.city != 'Moscow'
group by a.city 

Вопрос 5. Какая модель самолета летящего на рейсах из Анапы имеет больше всего мест?

select
    ac.model,
    count(distinct s.seat_no)
from 
    dst_project.flights f
    join dst_project.airports a on f.departure_airport = a.airport_code
    join dst_project.aircrafts ac on f.aircraft_code = ac.aircraft_code
    join dst_project.seats s on f.aircraft_code = s.aircraft_code 
where
    a.city = 'Anapa'
group by a.city, 1 
order by 2 desc